<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EuroPolytech Admissions Wizard</title>

  <link rel="icon" type="image/png" href="/favicon.png">

  <style>
    :root{
      --primary: #234feb;
      --accent: #ffd22a;
      --bg: #f6f8ff;
      --card: rgba(255,255,255,.92);
      --text: #0f172a;
      --muted: #5b647a;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, .10);
      --shadow2: 0 20px 60px rgba(17, 24, 39, .12);
      --radius: 18px;
      --radius2: 14px;
    }

    * { box-sizing: border-box; }

    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.35;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(35,79,235,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,210,42,.22), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      min-height: 100vh;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 16px 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .title{
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 22px;
      padding: 0 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(35,79,235,.25);
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 700;
    }
    .brand .subtitle{ color: var(--muted); font-size: 12px; }

    .row{ display:flex; gap:16px; flex-wrap: wrap; }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h2{
      margin: 0 0 10px 0;
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .muted{ color: var(--muted); }

    label{
      display:block;
      font-size: 12px;
      margin-top: 10px;
      color: rgba(15,23,42,.85);
      font-weight: 650;
    }

    input, select, textarea{
      width: 100%;
      padding: 11px 12px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.95);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
      font-size: 14px;
      color: var(--text);
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(35,79,235,.55);
      box-shadow: 0 0 0 4px rgba(35,79,235,.16);
    }

    .small{ font-size: 12px; color: var(--muted); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .split{ grid-template-columns: 1fr; }
    }

    button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(35,79,235,.65);
      background: linear-gradient(180deg, rgba(35,79,235,1) 0%, rgba(28,64,210,1) 100%);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .01em;
      transition: filter .2s ease, opacity .2s ease;
      min-height: 42px;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{ filter: brightness(1.03); }
    button:disabled{ opacity: .55; cursor: not-allowed; filter:none; }

    button.secondary{
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.9);
      color: var(--text);
      font-weight: 750;
    }

    button.accent{
      border: 1px solid rgba(255,210,42,.85);
      background: linear-gradient(180deg, rgba(255,210,42,1) 0%, rgba(245,193,15,1) 100%);
      color: #111827;
      font-weight: 900;
    }

    .photoWrap{
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 5;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.04);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #photoPreview{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .photoBadge{
      position: absolute;
      left: 10px;
      bottom: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.88);
      max-width: calc(100% - 20px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .avatarWrap{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .avatarImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .avatarBadge{
      position:absolute;
      left: 8px;
      bottom: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      background: rgba(15,23,42,.85);
      color: #fff;
      border: 1px solid rgba(255,255,255,.22);
      max-width: calc(100% - 16px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 12px;
      border: 1px solid rgba(35,79,235,.20);
      border-radius: 999px;
      font-size: 12px;
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 800;
    }
    .pill.neutral{
      border-color: rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      color: rgba(15,23,42,.75);
    }

    table{
      width:100%;
      border-collapse: collapse;
      border-spacing: 0;
      overflow:hidden;
      border-radius: var(--radius);
    }
    th, td{
      border-bottom: 1px solid rgba(15,23,42,.08);
      padding: 10px 10px;
      text-align:left;
      font-size: 13px;
      vertical-align: top;
    }
    thead th{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: rgba(15,23,42,.62);
      background: rgba(35,79,235,.04);
    }
    tbody tr:hover{ background: rgba(35,79,235,.04); }

    a{ color: var(--primary); text-decoration: none; font-weight: 750; }
    a:hover{ text-decoration: underline; }

    .guidance{ border-style: dashed; background: rgba(255,255,255,.75); }

    /* PIN Gate */
    #pinGate{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      background:
        radial-gradient(1000px 700px at 10% 15%, rgba(35,79,235,.24), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(255,210,42,.24), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      padding: 18px;
    }
    .pinCard{
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      padding: 22px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .pinTitle{ font-weight: 900; letter-spacing: -0.02em; margin: 0 0 6px 0; }
    .pinSub{ margin: 0 0 14px 0; color: var(--muted); font-size: 13px; }
    .pinBrandLine{ display:flex; justify-content:center; gap:10px; margin-bottom: 14px; align-items:center; }
    .pinMark{ width: 14px; height: 14px; border-radius: 4px; background: var(--primary); box-shadow: 0 0 0 4px rgba(35,79,235,.14); }
    .pinMark2{ width: 14px; height: 14px; border-radius: 4px; background: var(--accent); box-shadow: 0 0 0 4px rgba(255,210,42,.18); }
    #pinError{ margin-top: 10px; color: #b91c1c; font-size: 13px; display:none; font-weight: 700; }
  </style>
</head>

<body>
  <!-- PIN Gate -->
  <div id="pinGate" aria-label="PIN access gate">
    <div class="pinCard">
      <div class="pinBrandLine" aria-hidden="true">
        <span class="pinMark"></span><span class="pinMark2"></span>
        <span class="badge">EuroPolytech Academy</span>
      </div>
      <h2 class="pinTitle">Restricted Access</h2>
      <p class="pinSub">Enter the internal access PIN to continue.</p>
      <input id="pinInput" type="password" placeholder="Internal password" autocomplete="current-password" />
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="accent" id="pinBtn" style="width:100%;">Access</button>
      </div>
      <div id="pinError">Incorrect PIN. Please try again.</div>
      <div class="small muted" style="margin-top:12px;">Tip: hard refresh (Ctrl+F5) after updates.</div>
    </div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="title">
          EuroPolytech Admissions Wizard
          <span class="badge">Internal</span>
        </div>
        <div class="subtitle">Google Sheets dashboard · Manual Zoho updates · Photo upload to Drive</div>
      </div>
      <div class="hint" title="EuroPolytech Academy">
        <img
          src="https://www.europolytech.academy/EuroPolytech%20Logo%20jpeg.png"
          alt="EuroPolytech Academy logo"
          style="height:28px; width:auto; display:block;"
        />
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1; min-width: 320px;">
        <h2>Officer session</h2>
        <label>Officer name (typed)</label>
        <input id="officerName" placeholder="e.g., Amine / Sarah Smith" />
        <div class="small muted" style="margin-top:8px;">Logged for each action (audit trail).</div>
      </div>

      <div class="card" style="flex:1; min-width: 260px;">
        <h2>Applicant</h2>
        <div class="photoWrap">
          <img id="photoPreview" alt="Applicant photo" referrerpolicy="no-referrer" crossorigin="anonymous" />
          <div id="photoBadge" class="photoBadge">No student loaded</div>
        </div>
        <div class="small muted" id="photoMeta" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="flex:2; min-width: 320px;">
        <h2>Create / load student</h2>
        <div class="split">
          <div>
            <label>Full name</label>
            <input id="fullName" placeholder="Student full name" />
          </div>
          <div>
            <label>Email (key identifier)</label>
            <input id="email" placeholder="student@email.com" />
          </div>
          <div>
            <label>Programme</label>
            <input id="programme" placeholder="e.g., OTHM Level 3" />
          </div>
          <div>
            <label>Intake</label>
            <input id="intake" placeholder="e.g., Feb 2026" />
          </div>
          <div>
            <label>Nationality</label>
            <input id="nationality" placeholder="e.g., Pakistan" />
          </div>

          <div style="display:flex; align-items:end; gap:10px;">
            <button id="createLoadBtn" style="width:100%;">Create / Load</button>
            <button class="secondary" id="refreshListBtn" style="width:100%;">Refresh list</button>
          </div>
        </div>

        <div id="currentStudentMeta" class="small" style="margin-top:10px;"></div>

        <!-- Photo Panel -->
        <div id="photoPanel" class="card" style="margin-top:12px; display:none;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="avatarWrap">
                <img id="appPhotoImg" class="avatarImg" alt="Applicant photo" referrerpolicy="no-referrer" crossorigin="anonymous" />
                <div id="appStatusBadge" class="avatarBadge">No status</div>
              </div>
              <div>
                <div style="font-weight:900; letter-spacing:-0.02em;">Applicant photo</div>
                <div class="small muted" id="photoMetaLine">Load a student to manage photo.</div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label>Upload / update photo</label>
            <input id="photoInput" type="file" accept="image/*" />

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button id="uploadPhotoBtn" type="button" class="accent" disabled style="flex:1 1 220px;">Upload photo</button>
              <button id="clearPhotoSelectionBtn" type="button" class="secondary" disabled style="flex:1 1 220px;">Clear selection</button>
            </div>

            <div id="photoHint" class="small muted" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card" style="flex:1; min-width: 340px;">
        <h2>Guided process</h2>

        <label>Current stage</label>
        <div id="currentStage" class="pill neutral">No student loaded</div>

        <label style="margin-top:14px;">Move to next stage</label>
        <select id="stageSelect" disabled>
          <option value="">Select stage…</option>
        </select>

        <label>Details / note (will be logged)</label>
        <textarea id="details" rows="3" placeholder="Checked docs, requested missing items, etc."></textarea>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="updateStageBtn" disabled style="width:100%;">Log update</button>
          <button class="secondary" id="printCardBtn" disabled style="width:100%;">Print / Save PDF</button>
        </div>

        <div id="stageGuidance" class="card guidance" style="margin-top:14px;">
          <b>Guidance will appear here.</b>
          <div class="small muted">Load a student and select a stage.</div>
        </div>
      </div>

      <div class="card" style="flex:2; min-width: 340px;">
        <h2>All students (Live Dashboard)</h2>
        <div class="small muted">Click an email to load that student.</div>
        <div style="overflow:auto; margin-top:10px;">
          <table id="studentsTable" aria-label="Students list">
            <thead>
              <tr>
                <th>StudentID</th><th>Name</th><th>Email</th><th>Programme</th><th>Stage</th><th>Updated</th><th>By</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Print -->
    <div id="printArea" class="card" style="margin-top:20px; display:none;">
      <h2 style="margin:0 0 8px 0;">Student Status Card</h2>
      <div class="small muted" id="printGenerated"></div>
      <div style="margin-top:10px;">
        <div><b>Student:</b> <span id="pName"></span></div>
        <div><b>StudentID:</b> <span id="pId"></span></div>
        <div><b>Email:</b> <span id="pEmail"></span></div>
        <div><b>Programme:</b> <span id="pProgramme"></span></div>
        <div><b>Intake:</b> <span id="pIntake"></span></div>
        <div><b>Nationality:</b> <span id="pNationality"></span></div>
        <div style="margin-top:8px;"><b>Current Stage:</b> <span class="pill" id="pStage"></span></div>
        <div style="margin-top:8px;"><b>Last Updated:</b> <span id="pUpdated"></span> <span class="muted">by</span> <span id="pBy"></span></div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycbwfftiKCNvrGvhHXH9KeobeFybuEb3-fJEK8w7fQJJOySKl8d1dXblKAAuiztPkthgi2A/exec";
  const ACCESS_PIN = "Europolytech25.";

  // ====== Stages (UI only) ======
  const STAGES = [
    { key: "Application Submitted", guide: "Check completeness. Request missing documents if needed." },
    { key: "Under Review", guide: "Review eligibility (academic + English + fit)." },
    { key: "Eligible – Conditional", guide: "Eligible. Prepare Conditional LoA and collect declarations." },
    { key: "Conditional LoA Issued", guide: "Send Conditional LoA and record it in Zoho manually." },
    { key: "Accepted by Applicant", guide: "Confirm acceptance evidence received." },
    { key: "Declarations Signed", guide: "Collect signed declarations; keep in Zoho." },
    { key: "Fees Paid", guide: "Verify payment and issue receipt." },
    { key: "Final Enrolment Confirmed", guide: "Issue final confirmation; upload documents to Zoho." },
    { key: "Enrolled / Arrived", guide: "Confirm arrival and start attendance tracking." },
    { key: "Completed", guide: "Programme completed and archived." },
    { key: "Rejected", guide: "Not eligible; record reason." },
    { key: "Withdrawn", guide: "Applicant withdrew; record reason." },
  ];

  // ====== State ======
  let currentStudent = null;
  let selectedPhotoDataUrl = "";

  // ====== Helpers ======
  function officer() {
    return (document.getElementById("officerName").value || "").trim();
  }

  function safeEmail(v) {
    return String(v || "").trim().toLowerCase();
  }

  async function api(action, payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action, ...payload })
    });
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch { throw new Error("API did not return JSON: " + text.slice(0, 160)); }
    if (!json.ok) throw new Error(json.error || "API error");
    return json.data;
  }

  function initialsFromName(name) {
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    const a = parts[0] ? parts[0][0] : "E";
    const b = parts[1] ? parts[1][0] : "P";
    return (a + b).toUpperCase();
  }

  function makeInitialsAvatarDataUrl(initials) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(35,79,235,0.25)"/>
            <stop offset="100%" stop-color="rgba(255,210,42,0.25)"/>
          </linearGradient>
        </defs>
        <rect width="100%" height="100%" rx="24" fill="url(#g)"/>
        <text x="50%" y="54%" font-size="46" font-family="Arial" font-weight="800"
              fill="#0f172a" text-anchor="middle" dominant-baseline="middle">${initials}</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function resolvePhotoSrc(stu) {
    if (!stu) return "";
    const url = String(stu.PhotoURL || "").trim();
    const fileId = String(stu.PhotoFileId || "").trim();
    const bust = "v=" + Date.now();

    if (url) return url + (url.includes("?") ? "&" : "?") + bust;
    if (fileId) return `https://drive.google.com/thumbnail?id=${encodeURIComponent(fileId)}&sz=w800&${bust}`;
    return "";
  }

  function setBigPreview(stu) {
    const bigImg = document.getElementById("photoPreview");
    const badge = document.getElementById("photoBadge");
    const meta = document.getElementById("photoMeta");

    badge.textContent = (stu && stu.CurrentStage) ? stu.CurrentStage : "No student loaded";

    const src = resolvePhotoSrc(stu);
    if (!src) {
      bigImg.removeAttribute("src");
      bigImg.style.display = "none";
      meta.textContent = "No photo uploaded yet.";
      return;
    }

    bigImg.onload = () => { bigImg.style.display = "block"; };
    bigImg.onerror = () => {
      bigImg.style.display = "none";
      meta.textContent = "Photo exists but failed to load. If Drive blocks it, we’ll switch to proxy mode in back-end.";
    };
    bigImg.src = src;
    meta.textContent = "Photo stored in Drive and linked to the student record.";
  }

  function renderPhotoPanel(stu) {
    const panel = document.getElementById("photoPanel");
    const appPhotoImg = document.getElementById("appPhotoImg");
    const appStatusBadge = document.getElementById("appStatusBadge");
    const photoMetaLine = document.getElementById("photoMetaLine");
    const hint = document.getElementById("photoHint");
    const uploadBtn = document.getElementById("uploadPhotoBtn");
    const clearBtn = document.getElementById("clearPhotoSelectionBtn");

    if (!stu || !stu.Email) {
      panel.style.display = "none";
      return;
    }
    panel.style.display = "block";

    appStatusBadge.textContent = String(stu.CurrentStage || "No status");
    photoMetaLine.textContent = `StudentID: ${stu.StudentID || "—"} · Email: ${stu.Email || "—"}`;

    const storedSrc = resolvePhotoSrc(stu);
    if (storedSrc) appPhotoImg.src = storedSrc;
    else if (selectedPhotoDataUrl) appPhotoImg.src = selectedPhotoDataUrl;
    else appPhotoImg.src = makeInitialsAvatarDataUrl(initialsFromName(stu.FullName));

    const canUpload = !!selectedPhotoDataUrl;
    uploadBtn.disabled = !canUpload;
    clearBtn.disabled = !canUpload;

    const hasStored = !!(String(stu.PhotoURL || "").trim() || String(stu.PhotoFileId || "").trim());
    hint.textContent = hasStored
      ? "Current photo is saved. You can upload a new one anytime."
      : "No photo saved yet. Choose an image and click Upload.";
  }

  function setStudentUI(stu) {
    currentStudent = stu || null;

    const stageEl = document.getElementById("currentStage");
    const meta = document.getElementById("currentStudentMeta");
    const stageSelect = document.getElementById("stageSelect");

    if (stu && stu.CurrentStage) {
      stageEl.textContent = stu.CurrentStage;
      stageEl.classList.remove("neutral");
    } else {
      stageEl.textContent = "No student loaded";
      stageEl.classList.add("neutral");
    }

    meta.textContent = stu
      ? `Loaded: ${stu.FullName || "—"} (${stu.Email || "—"}) · ID: ${stu.StudentID || "—"} · Updated: ${stu.LastUpdatedAt || "—"} by ${stu.LastUpdatedBy || "—"}`
      : "";

    stageSelect.disabled = !stu;
    document.getElementById("updateStageBtn").disabled = !stu;
    document.getElementById("printCardBtn").disabled = !stu;

    // reset guidance
    if (stu) {
      stageSelect.value = "";
      document.getElementById("stageGuidance").innerHTML =
        `<b>Next step</b><div class="small muted" style="margin-top:6px;">Select a stage to see guidance, then log the update.</div>`;
    }

    setBigPreview(stu);
    renderPhotoPanel(stu);
  }

  async function refreshList() {
    const list = await api("listStudents", {});
    const tbody = document.querySelector("#studentsTable tbody");
    tbody.innerHTML = "";

    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.StudentID || ""}</td>
        <td>${s.FullName || ""}</td>
        <td><a href="#" data-email="${String(s.Email || "")}">${s.Email || ""}</a></td>
        <td>${s.Programme || ""}</td>
        <td><span class="pill">${s.CurrentStage || ""}</span></td>
        <td>${(s.LastUpdatedAt || "").toString().replace("T", " ").slice(0,19)}</td>
        <td>${s.LastUpdatedBy || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("a[data-email]").forEach(a => {
      a.addEventListener("click", async (ev) => {
        ev.preventDefault();
        const email = a.getAttribute("data-email");
        const stu = await api("getStudentByEmail", { email: safeEmail(email) });
        setStudentUI(stu);
      });
    });
  }

  // ====== Wire stage dropdown ======
  const stageSelect = document.getElementById("stageSelect");
  STAGES.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = s.key;
    stageSelect.appendChild(opt);
  });

  stageSelect.addEventListener("change", () => {
    const s = STAGES.find(x => x.key === stageSelect.value);
    document.getElementById("stageGuidance").innerHTML =
      `<b>${s ? s.key : "Guidance"}</b><div class="small muted" style="margin-top:6px;">${s ? s.guide : ""}</div>`;
  });

  // ====== PIN ======
  function checkPin() {
    const entered = (document.getElementById("pinInput").value || "").trim();
    if (entered === ACCESS_PIN) {
      document.getElementById("pinGate").style.display = "none";
      sessionStorage.setItem("ep_pin_ok", "1");
    } else {
      document.getElementById("pinError").style.display = "block";
    }
  }

  document.getElementById("pinBtn").addEventListener("click", checkPin);
  document.addEventListener("keydown", (e) => {
    const gate = document.getElementById("pinGate");
    const gateVisible = gate && gate.style.display !== "none";
    if (gateVisible && e.key === "Enter") checkPin();
  });
  window.addEventListener("load", () => {
    if (sessionStorage.getItem("ep_pin_ok") === "1") {
      document.getElementById("pinGate").style.display = "none";
    }
  });

  // ====== Create / Load ======
  document.getElementById("createLoadBtn").addEventListener("click", async () => {
    const off = officer();
    if (!off) return alert("Please type the officer name first.");

    const payload = {
      officer: off,
      fullName: document.getElementById("fullName").value,
      email: safeEmail(document.getElementById("email").value),
      programme: document.getElementById("programme").value,
      intake: document.getElementById("intake").value,
      nationality: document.getElementById("nationality").value,
    };

    if (!payload.email) return alert("Email is required.");

    try {
      const stu = await api("createOrLoadStudent", payload);
      setStudentUI(stu);
      await refreshList();
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("refreshListBtn").addEventListener("click", async () => {
    try { await refreshList(); } catch (e) { alert(e.message); }
  });

  // ====== Stage update ======
  document.getElementById("updateStageBtn").addEventListener("click", async () => {
    const off = officer();
    if (!off) return alert("Please type the officer name first.");
    if (!currentStudent || !currentStudent.Email) return alert("Load a student first.");

    const newStage = stageSelect.value;
    if (!newStage) return alert("Select a stage.");

    const details = document.getElementById("details").value;

    try {
      const stu = await api("updateStage", {
        email: safeEmail(currentStudent.Email),
        officer: off,
        newStage,
        details,
        studentId: currentStudent.StudentID || "" // for audit safety
      });

      setStudentUI(stu);
      document.getElementById("details").value = "";
      await refreshList();
      alert("Logged. Reminder: update Zoho CRM manually as per your process.");
    } catch (e) {
      alert(e.message);
    }
  });

  // ====== Photo: choose ======
  document.getElementById("photoInput").addEventListener("change", () => {
    const input = document.getElementById("photoInput");
    const file = input.files && input.files[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      alert("Please select an image file.");
      input.value = "";
      return;
    }
    if (file.size > 4 * 1024 * 1024) {
      alert("Please use a smaller image (max ~4MB).");
      input.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      selectedPhotoDataUrl = String(reader.result || "");
      renderPhotoPanel(currentStudent);
      document.getElementById("photoHint").textContent = "Preview ready ✔ Click Upload photo to save it.";
    };
    reader.readAsDataURL(file);
  });

  // ====== Photo: clear ======
  document.getElementById("clearPhotoSelectionBtn").addEventListener("click", () => {
    selectedPhotoDataUrl = "";
    document.getElementById("photoInput").value = "";
    renderPhotoPanel(currentStudent);
  });

  // ====== Photo: upload ======
  document.getElementById("uploadPhotoBtn").addEventListener("click", async () => {
    const off = officer();
    if (!off) return alert("Please type the officer name first.");
    if (!currentStudent || !currentStudent.Email) return alert("Load a student first.");
    if (!selectedPhotoDataUrl) return alert("Choose a photo first.");

    const btn = document.getElementById("uploadPhotoBtn");
    const hint = document.getElementById("photoHint");
    btn.disabled = true;
    hint.textContent = "Uploading photo…";

    try {
      const result = await api("uploadPhoto", {
        token: ACCESS_PIN,
        email: safeEmail(currentStudent.Email),
        studentId: currentStudent.StudentID || "",
        officer: off,
        dataUrl: selectedPhotoDataUrl
      });

      // IMPORTANT: your back-end returns { student: updatedStudent, fileId }
      const updated = result && result.student ? result.student : null;
      if (!updated) throw new Error("Upload succeeded but API did not return updated student.");

      selectedPhotoDataUrl = "";
      document.getElementById("photoInput").value = "";

      setStudentUI(updated);
      await refreshList();

      hint.textContent = "Uploaded ✔ Photo saved and linked to the student.";
    } catch (e) {
      alert(e.message);
      hint.textContent = "Upload failed. Please try again.";
    } finally {
      renderPhotoPanel(currentStudent);
      btn.disabled = false;
    }
  });

  // ===== Print =====
  document.getElementById("printCardBtn").addEventListener("click", () => {
    if (!currentStudent) return;

    document.getElementById("pName").textContent = currentStudent.FullName || "";
    document.getElementById("pId").textContent = currentStudent.StudentID || "";
    document.getElementById("pEmail").textContent = currentStudent.Email || "";
    document.getElementById("pProgramme").textContent = currentStudent.Programme || "";
    document.getElementById("pIntake").textContent = currentStudent.Intake || "";
    document.getElementById("pNationality").textContent = currentStudent.Nationality || "";
    document.getElementById("pStage").textContent = currentStudent.CurrentStage || "";
    document.getElementById("pUpdated").textContent = currentStudent.LastUpdatedAt || "";
    document.getElementById("pBy").textContent = currentStudent.LastUpdatedBy || "";

    document.getElementById("printGenerated").textContent =
      `Generated: ${new Date().toLocaleString()} · Officer session: ${officer() || "—"}`;

    document.getElementById("printArea").style.display = "block";
    window.print();
    document.getElementById("printArea").style.display = "none";
  });

  // ===== Initial list =====
  (async () => {
    try { await refreshList(); }
    catch (e) { console.warn(e); }
  })();
</script>
</body>
</html>

