<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EuroPolytech Admissions Wizard</title>

  <style>
    :root{
      --primary: #234feb;
      --accent: #ffd22a;
      --bg: #f6f8ff;
      --card: rgba(255,255,255,.92);
      --text: #0f172a;
      --muted: #5b647a;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, .10);
      --shadow2: 0 20px 60px rgba(17, 24, 39, .12);
      --radius: 18px;
      --radius2: 14px;
    }

    * { box-sizing: border-box; }

    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.35;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(35,79,235,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,210,42,.22), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      min-height: 100vh;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 16px 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 22px;
      padding: 0 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(35,79,235,.25);
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 700;
    }
    .brand .subtitle{
      color: var(--muted);
      font-size: 12px;
    }

    .hint{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,210,42,.25);
    }

    /* Layout */
    .row{
      display:flex;
      gap:16px;
      flex-wrap: wrap;
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h2{
      margin: 0 0 10px 0;
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .muted{ color: var(--muted); }

    label{
      display:block;
      font-size: 12px;
      margin-top: 10px;
      color: rgba(15,23,42,.85);
      font-weight: 650;
    }

    input, select, textarea{
      width: 100%;
      padding: 11px 12px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.95);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
      font-size: 14px;
      color: var(--text);
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(35,79,235,.55);
      box-shadow: 0 0 0 4px rgba(35,79,235,.16);
    }

    .small{ font-size: 12px; color: var(--muted); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .split{ grid-template-columns: 1fr; }
    }

    /* Buttons */
    button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(35,79,235,.65);
      background: linear-gradient(180deg, rgba(35,79,235,1) 0%, rgba(28,64,210,1) 100%);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .01em;
      transition: transform .05s ease, box-shadow .2s ease, filter .2s ease, opacity .2s ease;
      min-height: 42px;
      text-align:center;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{
      filter: brightness(1.03);
      box-shadow: 0 10px 24px rgba(35,79,235,.22);
    }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      filter:none;
    }

    button.secondary{
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.9);
      color: var(--text);
      font-weight: 750;
    }
    button.secondary:hover{
      box-shadow: 0 10px 24px rgba(17,24,39,.10);
    }

    button.accent{
      border: 1px solid rgba(255,210,42,.85);
      background: linear-gradient(180deg, rgba(255,210,42,1) 0%, rgba(245,193,15,1) 100%);
      color: #111827;
      font-weight: 900;
    }
    button.accent:hover{
      box-shadow: 0 10px 24px rgba(255,210,42,.20);
    }

    /* Pills + table */
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 12px;
      border: 1px solid rgba(35,79,235,.20);
      border-radius: 999px;
      font-size: 12px;
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 800;
    }
    .pill.neutral{
      border-color: rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      color: rgba(15,23,42,.75);
    }

    table{
      width:100%;
      border-collapse: collapse;
      border-spacing: 0;
      overflow:hidden;
      border-radius: var(--radius);
    }
    th, td{
      border-bottom: 1px solid rgba(15,23,42,.08);
      padding: 10px 10px;
      text-align:left;
      font-size: 13px;
      vertical-align: top;
    }
    thead th{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: rgba(15,23,42,.62);
      background: rgba(35,79,235,.04);
    }
    tbody tr:hover{
      background: rgba(35,79,235,.04);
    }
    a{
      color: var(--primary);
      text-decoration: none;
      font-weight: 750;
    }
    a:hover{ text-decoration: underline; }

    /* Guidance panel */
    .guidance{
      border-style: dashed;
      background: rgba(255,255,255,.75);
    }

    /* Print card only */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: fixed; left: 0; top: 0; width: 100%; margin: 0; }
      .container{ padding: 0; }
    }

    /* PIN Gate */
    #pinGate{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      background:
        radial-gradient(1000px 700px at 10% 15%, rgba(35,79,235,.24), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(255,210,42,.24), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      padding: 18px;
    }
    .pinCard{
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      padding: 22px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .pinTitle{
      font-weight: 900;
      letter-spacing: -0.02em;
      margin: 0 0 6px 0;
    }
    .pinSub{
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13px;
    }
    .pinBrandLine{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-bottom: 14px;
      align-items:center;
    }
    .pinMark{
      width: 14px; height: 14px; border-radius: 4px;
      background: var(--primary);
      box-shadow: 0 0 0 4px rgba(35,79,235,.14);
    }
    .pinMark2{
      width: 14px; height: 14px; border-radius: 4px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,210,42,.18);
    }
    #pinError{
      margin-top: 10px;
      color: #b91c1c;
      font-size: 13px;
      display:none;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <!-- PIN Gate -->
  <div id="pinGate" aria-label="PIN access gate">
    <div class="pinCard">
      <div class="pinBrandLine" aria-hidden="true">
        <span class="pinMark"></span><span class="pinMark2"></span>
        <span class="badge">EuroPolytech Academy</span>
      </div>

      <h2 class="pinTitle">Restricted Access</h2>
      <p class="pinSub">Enter the internal access PIN to continue.</p>

      <input
        id="pinInput"
        type="password"
        placeholder="Internal password"
        autocomplete="current-password"
      />

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="accent" onclick="checkPin()" style="width:100%;">Access</button>
      </div>

      <div id="pinError">Incorrect PIN. Please try again.</div>

      <div class="small muted" style="margin-top:12px;">
        Tip: use browser refresh if the page looks cached after updates.
      </div>
    </div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="title">
          EuroPolytech Admissions Wizard
          <span class="badge">Internal</span>
        </div>
        <div class="subtitle">Lightweight operational dashboard · Google Sheets log · Manual Zoho updates</div>
      </div>
      <div class="hint" title="Brand palette active">
        <span class="dot"></span>
        <span>Brand palette: <b style="color:var(--primary);">#234feb</b> + <b style="color:#a07a00;">#ffd22a</b></span>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1; min-width: 320px;">
        <h2>Officer session</h2>
        <label>Officer name (typed)</label>
        <input id="officerName" placeholder="e.g., Amine / Sarah Smith" />
        <div class="small muted" style="margin-top:8px;">
          This name is written into the audit log for each action (lightweight compliance trail).
        </div>
      </div>

      <div class="card" style="flex:2; min-width: 320px;">
        <h2>Create / load student</h2>
        <div class="split">
          <div>
            <label>Full name</label>
            <input id="fullName" placeholder="Student full name" />
          </div>
          <div>
            <label>Email (key identifier)</label>
            <input id="email" placeholder="student@email.com" />
          </div>
          <div>
            <label>Programme</label>
            <input id="programme" placeholder="e.g., SkillCamp Business" />
          </div>
          <div>
            <label>Intake</label>
            <input id="intake" placeholder="e.g., Feb 2026" />
          </div>
          <div>
            <label>Nationality</label>
            <input id="nationality" placeholder="e.g., Pakistan" />
          </div>
          <div style="display:flex; align-items:end; gap:10px;">
            <button id="createLoadBtn" style="width:100%;">Create / Load</button>
            <button class="secondary" id="refreshListBtn" style="width:100%;">Refresh list</button>
          </div>
        </div>
        <div id="currentStudentMeta" class="small" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card" style="flex:1; min-width: 340px;">
        <h2>Guided process</h2>
        <div class="small muted">Pick the next stage after completing checks and manual Zoho updates.</div>

        <label>Current stage</label>
        <div id="currentStage" class="pill neutral">No student loaded</div>

        <label style="margin-top:14px;">Move to next stage</label>
        <select id="stageSelect" disabled>
          <option value="">Select stage…</option>
        </select>

        <label>Details / note (will be logged)</label>
        <textarea id="details" rows="3" placeholder="E.g., Checked passport + academic docs. Missing English certificate; requested via email."></textarea>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="updateStageBtn" disabled style="width:100%;">Log update</button>
          <button class="secondary" id="printCardBtn" disabled style="width:100%;">Print / Save as PDF</button>
        </div>

        <div id="stageGuidance" class="card guidance" style="margin-top:14px;">
          <b>Guidance will appear here.</b>
          <div class="small muted">Load a student and select a stage.</div>
        </div>
      </div>

      <div class="card" style="flex:2; min-width: 340px;">
        <h2>All students (from Google Sheet)</h2>
        <div class="small muted">Your live operational dashboard.</div>
        <div style="overflow:auto; margin-top:10px;">
          <table id="studentsTable" aria-label="Students list">
            <thead>
              <tr>
                <th>StudentID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Programme</th>
                <th>Stage</th>
                <th>Updated</th>
                <th>By</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Tip: click an email address to load that student.
        </div>
      </div>
    </div>

    <!-- Print area -->
    <div id="printArea" class="card" style="margin-top:20px; display:none;">
      <h2 style="margin:0 0 8px 0;">Student Status Card</h2>
      <div class="small muted" id="printGenerated"></div>
      <div style="margin-top:10px;">
        <div><b>Student:</b> <span id="pName"></span></div>
        <div><b>StudentID:</b> <span id="pId"></span></div>
        <div><b>Email:</b> <span id="pEmail"></span></div>
        <div><b>Programme:</b> <span id="pProgramme"></span></div>
        <div><b>Intake:</b> <span id="pIntake"></span></div>
        <div><b>Nationality:</b> <span id="pNationality"></span></div>
        <div style="margin-top:8px;"><b>Current Stage:</b> <span class="pill" id="pStage"></span></div>
        <div style="margin-top:8px;"><b>Last Updated:</b> <span id="pUpdated"></span> <span class="muted">by</span> <span id="pBy"></span></div>
        <div style="margin-top:10px;"><b>Last Action:</b> <span id="pAction"></span></div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG: paste your Apps Script Web App URL here ======
  const API_URL = "https://script.google.com/macros/s/AKfycbx1_ka9lsMrAJFZ9Pu3MsZgO9sHTRKSSrFoJ_le22Z5mh1wCsj38G8G4GzEtssdOH-hvQ/exec";

  // ===== PIN CONFIG =====
  const ACCESS_PIN = "Europolytech25.";

  function checkPin() {
    const entered = (document.getElementById("pinInput").value || "").trim();
    if (entered === ACCESS_PIN) {
      document.getElementById("pinGate").style.display = "none";
      sessionStorage.setItem("ep_pin_ok", "1");
    } else {
      document.getElementById("pinError").style.display = "block";
    }
  }

  // Enter key support on PIN screen
  document.addEventListener("keydown", (e) => {
    const gateVisible = document.getElementById("pinGate") && document.getElementById("pinGate").style.display !== "none";
    if (gateVisible && e.key === "Enter") checkPin();
  });

  // Keep unlocked during session
  window.addEventListener("load", () => {
    if (sessionStorage.getItem("ep_pin_ok") === "1") {
      document.getElementById("pinGate").style.display = "none";
    }
  });

  // ====== Stages ======
  const STAGES = [
    { key: "Application Submitted", guide: `Check completeness. If missing docs, request them. Zoho: keep status 'Application Submitted' until complete.` },
    { key: "Under Review", guide: `Review eligibility (academic + English + short-stay fit). Zoho: add internal note with checks performed.` },
    { key: "Eligible – Conditional", guide: `Decision: eligible. Zoho: update status to 'Eligible – Conditional'. Prepare Conditional LoA.` },
    { key: "Conditional LoA Issued", guide: `Send Conditional LoA manually. Zoho: attach LoA PDF + set status 'Conditional LoA Issued'.` },
    { key: "Accepted by Applicant", guide: `Confirm acceptance received (email/form). Zoho: upload evidence + set status 'Accepted by Applicant'.` },
    { key: "Declarations Signed", guide: `Collect signed declarations (no-work, short-stay, refund policy). Zoho: upload + tick compliance + set status 'Declarations Signed'.` },
    { key: "Fees Paid", guide: `Verify payment received + receipt issued. Zoho: set Payment Status 'Paid' + set status 'Fees Paid'.` },
    { key: "Final Enrolment Confirmed", guide: `Issue final enrolment confirmation manually (visa/border usable). Zoho: attach + set status 'Final Enrolment Confirmed'.` },
    { key: "Enrolled / Arrived", guide: `Confirm arrival, collect entry stamp if relevant, start attendance tracking. Zoho: set status 'Enrolled / Arrived'.` },
    { key: "Completed", guide: `Programme completed. Zoho: set status 'Completed' + archive documents as per policy.` },
    { key: "Rejected", guide: `Not eligible. Zoho: set status 'Rejected' + record reason clearly.` },
    { key: "Withdrawn", guide: `Applicant withdrew. Zoho: set status 'Withdrawn' + record reason if known.` },
  ];

  // ====== State ======
  let currentStudent = null;

  // Populate stages
  const stageSelect = document.getElementById("stageSelect");
  STAGES.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = s.key;
    stageSelect.appendChild(opt);
  });

  stageSelect.addEventListener("change", () => {
    const s = STAGES.find(x => x.key === stageSelect.value);
    document.getElementById("stageGuidance").innerHTML =
      `<b>${s ? s.key : "Guidance"}</b><div class="small muted" style="margin-top:6px;">${s ? s.guide : ""}</div>`;
  });

async function api(action, payload) {
  let res;

  try {
    res = await fetch(API_URL, {
      method: "POST",
      // IMPORTANT: no Content-Type header (avoids CORS preflight)
      body: JSON.stringify({ action, ...payload })
    });
  } catch (err) {
    throw new Error("Failed to reach the API. Check the Apps Script deployment access and URL.");
  }

  const text = await res.text();

  let json;
  try {
    json = JSON.parse(text);
  } catch {
    throw new Error("API did not return JSON. First 200 chars: " + text.slice(0, 200));
  }

  if (!json.ok) throw new Error(json.error || "API error");
  return json.data;
}

  function officer() {
    return (document.getElementById("officerName").value || "").trim();
  }

  function setStudentUI(stu) {
    currentStudent = stu;

    const currentStageEl = document.getElementById("currentStage");
    if (stu && stu.CurrentStage) {
      currentStageEl.textContent = stu.CurrentStage;
      currentStageEl.classList.remove("neutral");
    } else {
      currentStageEl.textContent = "No student loaded";
      currentStageEl.classList.add("neutral");
    }

    document.getElementById("currentStudentMeta").textContent = stu
      ? `Loaded: ${stu.FullName || "—"} (${stu.Email}) · ID: ${stu.StudentID} · Updated: ${stu.LastUpdatedAt || "—"} by ${stu.LastUpdatedBy || "—"}`
      : "";

    stageSelect.disabled = !stu;
    document.getElementById("updateStageBtn").disabled = !stu;
    document.getElementById("printCardBtn").disabled = !stu;

    if (stu) {
      stageSelect.value = "";
      document.getElementById("stageGuidance").innerHTML =
        `<b>Next step</b><div class="small muted" style="margin-top:6px;">Select a stage to see guidance, then log the update when done.</div>`;
    }
  }

  async function refreshList() {
    const list = await api("listStudents", {});
    const tbody = document.querySelector("#studentsTable tbody");
    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.StudentID || ""}</td>
        <td>${s.FullName || ""}</td>
        <td><a href="#" data-email="${s.Email}">${s.Email || ""}</a></td>
        <td>${s.Programme || ""}</td>
        <td><span class="pill">${s.CurrentStage || ""}</span></td>
        <td>${s.LastUpdatedAt || ""}</td>
        <td>${s.LastUpdatedBy || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    // Click email to load
    tbody.querySelectorAll("a[data-email]").forEach(a => {
      a.addEventListener("click", async (ev) => {
        ev.preventDefault();
        const email = a.getAttribute("data-email");
        const stu = await api("getStudentByEmail", { email });
        setStudentUI(stu);
      });
    });
  }

  document.getElementById("createLoadBtn").addEventListener("click", async () => {
    const off = officer();
    if (!off) return alert("Please type the officer name first.");

    const payload = {
      officer: off,
      fullName: document.getElementById("fullName").value,
      email: document.getElementById("email").value,
      programme: document.getElementById("programme").value,
      intake: document.getElementById("intake").value,
      nationality: document.getElementById("nationality").value,
    };

    try {
      const stu = await api("createOrLoadStudent", payload);
      setStudentUI(stu);
      await refreshList();
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("refreshListBtn").addEventListener("click", async () => {
    try { await refreshList(); } catch(e){ alert(e.message); }
  });

  document.getElementById("updateStageBtn").addEventListener("click", async () => {
    const off = officer();
    if (!off) return alert("Please type the officer name first.");
    if (!currentStudent) return alert("Load a student first.");
    const newStage = stageSelect.value;
    if (!newStage) return alert("Select a stage.");
    const details = document.getElementById("details").value;

    try {
      const stu = await api("updateStage", { email: currentStudent.Email, officer: off, newStage, details });
      setStudentUI(stu);
      document.getElementById("details").value = "";
      await refreshList();
      alert("Logged. Reminder: now go to Zoho CRM and update the record manually as per guidance.");
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("printCardBtn").addEventListener("click", () => {
    if (!currentStudent) return;

    document.getElementById("pName").textContent = currentStudent.FullName || "";
    document.getElementById("pId").textContent = currentStudent.StudentID || "";
    document.getElementById("pEmail").textContent = currentStudent.Email || "";
    document.getElementById("pProgramme").textContent = currentStudent.Programme || "";
    document.getElementById("pIntake").textContent = currentStudent.Intake || "";
    document.getElementById("pNationality").textContent = currentStudent.Nationality || "";
    document.getElementById("pStage").textContent = currentStudent.CurrentStage || "";
    document.getElementById("pUpdated").textContent = currentStudent.LastUpdatedAt || "";
    document.getElementById("pBy").textContent = currentStudent.LastUpdatedBy || "";
    document.getElementById("pAction").textContent = currentStudent.LastAction || "";

    document.getElementById("printGenerated").textContent =
      `Generated: ${new Date().toLocaleString()} · Officer session: ${officer() || "—"}`;

    document.getElementById("printArea").style.display = "block";
    window.print();
    document.getElementById("printArea").style.display = "none";
  });

  // Initial load
  (async () => {
    if (API_URL.includes("PASTE_YOUR_WEB_APP_URL_HERE")) {
      alert("Set API_URL in the HTML to your Apps Script Web App URL.");
      return;
    }
    await refreshList();
  })();
</script>
</body>
</html>
