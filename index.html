<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EuroPolytech Admissions Wizard</title>

  <link rel="icon" type="image/png" href="/favicon.png">

  <style>
    :root{
      --primary: #234feb;
      --accent: #ffd22a;
      --bg: #f6f8ff;
      --card: rgba(255,255,255,.92);
      --text: #0f172a;
      --muted: #5b647a;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, .10);
      --shadow2: 0 20px 60px rgba(17, 24, 39, .12);
      --radius: 18px;
      --radius2: 14px;
    }

    * { box-sizing: border-box; }

    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.35;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(35,79,235,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,210,42,.22), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      min-height: 100vh;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 16px 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 22px;
      padding: 0 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(35,79,235,.25);
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 700;
    }
    .brand .subtitle{
      color: var(--muted);
      font-size: 12px;
    }

    .hint{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Layout */
    .row{
      display:flex;
      gap:16px;
      flex-wrap: wrap;
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h2{
      margin: 0 0 10px 0;
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .muted{ color: var(--muted); }

    label{
      display:block;
      font-size: 12px;
      margin-top: 10px;
      color: rgba(15,23,42,.85);
      font-weight: 650;
    }

    input, select, textarea{
      width: 100%;
      padding: 11px 12px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.95);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
      font-size: 14px;
      color: var(--text);
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(35,79,235,.55);
      box-shadow: 0 0 0 4px rgba(35,79,235,.16);
    }

    .small{ font-size: 12px; color: var(--muted); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .split{ grid-template-columns: 1fr; }
    }

    /* Buttons */
    button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(35,79,235,.65);
      background: linear-gradient(180deg, rgba(35,79,235,1) 0%, rgba(28,64,210,1) 100%);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .01em;
      transition: transform .05s ease, box-shadow .2s ease, filter .2s ease, opacity .2s ease;
      min-height: 42px;
      text-align:center;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{
      filter: brightness(1.03);
      box-shadow: 0 10px 24px rgba(35,79,235,.22);
    }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      filter:none;
    }

    button.secondary{
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.9);
      color: var(--text);
      font-weight: 750;
    }
    button.secondary:hover{
      box-shadow: 0 10px 24px rgba(17,24,39,.10);
    }

    button.accent{
      border: 1px solid rgba(255,210,42,.85);
      background: linear-gradient(180deg, rgba(255,210,42,1) 0%, rgba(245,193,15,1) 100%);
      color: #111827;
      font-weight: 900;
    }
    button.accent:hover{
      box-shadow: 0 10px 24px rgba(255,210,42,.20);
    }

    /* Zoho Prefill buttons – responsive layout */
    .zohoBtnRow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .zohoBtnRow button{
      flex: 1 1 220px;
      min-width: 220px;
    }

    /* Applicant big preview card */
    .photoWrap{
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 5;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.04);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #photoPreview{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .photoBadge{
      position: absolute;
      left: 10px;
      bottom: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.88);
      max-width: calc(100% - 20px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Applicant small avatar in upload panel */
    .avatarWrap{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .avatarImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .avatarBadge{
      position:absolute;
      left: 8px;
      bottom: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .01em;
      background: rgba(15,23,42,.85);
      color: #fff;
      border: 1px solid rgba(255,255,255,.22);
      max-width: calc(100% - 16px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Pills + table */
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 12px;
      border: 1px solid rgba(35,79,235,.20);
      border-radius: 999px;
      font-size: 12px;
      background: rgba(35,79,235,.08);
      color: var(--primary);
      font-weight: 800;
    }
    .pill.neutral{
      border-color: rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      color: rgba(15,23,42,.75);
    }

    table{
      width:100%;
      border-collapse: collapse;
      border-spacing: 0;
      overflow:hidden;
      border-radius: var(--radius);
    }
    th, td{
      border-bottom: 1px solid rgba(15,23,42,.08);
      padding: 10px 10px;
      text-align:left;
      font-size: 13px;
      vertical-align: top;
    }
    thead th{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: rgba(15,23,42,.62);
      background: rgba(35,79,235,.04);
    }
    tbody tr:hover{
      background: rgba(35,79,235,.04);
    }
    a{
      color: var(--primary);
      text-decoration: none;
      font-weight: 750;
    }
    a:hover{ text-decoration: underline; }

    .guidance{
      border-style: dashed;
      background: rgba(255,255,255,.75);
    }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: fixed; left: 0; top: 0; width: 100%; margin: 0; }
      .container{ padding: 0; }
    }

    /* PIN Gate */
    #pinGate{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      background:
        radial-gradient(1000px 700px at 10% 15%, rgba(35,79,235,.24), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(255,210,42,.24), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      padding: 18px;
    }
    .pinCard{
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      padding: 22px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .pinTitle{ font-weight: 900; letter-spacing: -0.02em; margin: 0 0 6px 0; }
    .pinSub{ margin: 0 0 14px 0; color: var(--muted); font-size: 13px; }
    .pinBrandLine{ display:flex; justify-content:center; gap:10px; margin-bottom: 14px; align-items:center; }
    .pinMark{ width: 14px; height: 14px; border-radius: 4px; background: var(--primary); box-shadow: 0 0 0 4px rgba(35,79,235,.14); }
    .pinMark2{ width: 14px; height: 14px; border-radius: 4px; background: var(--accent); box-shadow: 0 0 0 4px rgba(255,210,42,.18); }
    #pinError{ margin-top: 10px; color: #b91c1c; font-size: 13px; display:none; font-weight: 700; }
  </style>
</head>

<body>
  <div id="pinGate" aria-label="PIN access gate">
    <div class="pinCard">
      <div class="pinBrandLine" aria-hidden="true">
        <span class="pinMark"></span><span class="pinMark2"></span>
        <span class="badge">EuroPolytech Academy</span>
      </div>
      <h2 class="pinTitle">Restricted Access</h2>
      <p class="pinSub">Enter the internal access PIN to continue.</p>
      <input id="pinInput" type="password" placeholder="Internal password" autocomplete="current-password" />
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="accent" onclick="checkPin()" style="width:100%;">Access</button>
      </div>
      <div id="pinError">Incorrect PIN. Please try again.</div>
      <div class="small muted" style="margin-top:12px;">
        Tip: use browser refresh if the page looks cached after updates.
      </div>
    </div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="title">
          EuroPolytech Admissions Wizard
          <span class="badge">Internal</span>
        </div>
        <div class="subtitle">Lightweight operational dashboard · Google Sheets log · Manual Zoho updates</div>
      </div>
      <div class="hint" title="EuroPolytech Academy">
        <img src="https://www.europolytech.academy/EuroPolytech%20Logo%20jpeg.png" alt="EuroPolytech Academy logo" style="height:28px; width:auto; display:block;" />
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1; min-width: 320px;">
        <h2>Officer session</h2>
        <label>Officer name (typed)</label>
        <input id="officerName" placeholder="e.g., Amine / Sarah Smith" />
        <div class="small muted" style="margin-top:8px;">Logged for each action (compliance trail).</div>
      </div>

      <div class="card" style="flex:1; min-width: 260px;">
        <h2>Applicant</h2>
        <div class="photoWrap">
          <img id="photoPreview" alt="Applicant photo" referrerpolicy="no-referrer" crossorigin="anonymous" />
          <div id="photoBadge" class="photoBadge">No student loaded</div>
        </div>
        <div class="small muted" id="photoMeta" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="flex:2; min-width: 320px;">
        <h2>Create / load student</h2>
        <div class="split">
          <div><label>Full name</label><input id="fullName" placeholder="Student full name" /></div>
          <div><label>Email (key identifier)</label><input id="email" placeholder="student@email.com" /></div>
          <div><label>Programme</label><input id="programme" placeholder="SkillCamp Business" /></div>
          <div><label>Intake</label><input id="intake" placeholder="Feb 2026" /></div>
          <div><label>Nationality</label><input id="nationality" placeholder="e.g., Pakistan" /></div>
          <div style="display:flex; align-items:end; gap:10px;">
            <button id="createLoadBtn" style="width:100%;">Create / Load</button>
            <button class="secondary" id="refreshListBtn" style="width:100%;">Refresh list</button>
          </div>
        </div>
        <div id="currentStudentMeta" class="small" style="margin-top:10px;"></div>

        <div id="photoPanel" class="card" style="margin-top:12px; display:none;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="avatarWrap">
                <img id="appPhotoImg" class="avatarImg" alt="Applicant photo" referrerpolicy="no-referrer" crossorigin="anonymous" />
                <div id="appStatusBadge" class="avatarBadge">No status</div>
              </div>
              <div>
                <div style="font-weight:900; letter-spacing:-0.02em;">Applicant photo</div>
                <div class="small muted" id="photoMetaLine">Load student to manage photo.</div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <label>Upload / update photo</label>
            <input id="photoInput" type="file" accept="image/*" />
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button id="uploadPhotoBtn" type="button" class="accent" disabled style="flex:1 1 220px;">Upload photo</button>
              <button id="clearPhotoSelectionBtn" type="button" class="secondary" disabled style="flex:1 1 220px;">Clear selection</button>
            </div>
            <div id="photoHint" class="small muted" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card" style="flex:1; min-width: 340px;">
        <h2>Guided process</h2>
        <label>Current stage</label>
        <div id="currentStage" class="pill neutral">No student loaded</div>
        <label style="margin-top:14px;">Move to next stage</label>
        <select id="stageSelect" disabled><option value="">Select stage…</option></select>
        <div id="zohoBlock" style="margin-top:10px; display:none;">
          <div class="zohoBtnRow">
            <button id="openZohoPrefillBtn" class="accent" disabled style="width:100%;">Open Zoho Form</button>
            <button id="copyZohoPrefillBtn" class="secondary" disabled style="width:100%;">Copy link</button>
          </div>
          <div id="zohoPrefillHint" class="small muted" style="margin-top:8px;"></div>
        </div>
        <label>Details / note (will be logged)</label>
        <textarea id="details" rows="3" placeholder="Checked docs, etc."></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="updateStageBtn" disabled style="width:100%;">Log update</button>
          <button class="secondary" id="printCardBtn" disabled style="width:100%;">Print / Save PDF</button>
        </div>
        <div id="stageGuidance" class="card guidance" style="margin-top:14px;"><b>Guidance will appear here.</b></div>
      </div>

      <div class="card" style="flex:2; min-width: 340px;">
        <h2>All students (Live Dashboard)</h2>
        <div style="overflow:auto; margin-top:10px;">
          <table id="studentsTable">
            <thead>
              <tr><th>ID</th><th>Name</th><th>Email</th><th>Prog</th><th>Stage</th><th>Updated</th><th>By</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="printArea" class="card" style="margin-top:20px; display:none;">
      <h2 style="margin:0 0 8px 0;">Student Status Card</h2>
      <div class="small muted" id="printGenerated"></div>
      <div style="margin-top:10px;">
        <div><b>Student:</b> <span id="pName"></span></div>
        <div><b>ID:</b> <span id="pId"></span></div>
        <div><b>Email:</b> <span id="pEmail"></span></div>
        <div><b>Stage:</b> <span class="pill" id="pStage"></span></div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycbx1_ka9lsMrAJFZ9Pu3MsZgO9sHTRKSSrFoJ_le22Z5mh1wCsj38G8G4GzEtssdOH-hvQ/exec";
  const ACCESS_PIN = "Europolytech25.";
  const ZOHO_FORM_BASE_URL = "https://forms.europolytech.academy/EuroPolytech/form/EuroPolytechOfferAcceptanceDeclarations/formperma/g8qUUaReFy8JQpuIGo0EnBb9jZ2DUUXaqkIU3ADJgTs";

  let currentStudent = null;
  let selectedPhotoDataUrl = "";

  // ====== API HELPER ======
  async function api(action, payload) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action, ...payload })
      });
      const text = await res.text();
      const json = JSON.parse(text);
      if (!json.ok) throw new Error(json.error || "API error");
      return json.data;
    } catch (err) {
      console.error(err);
      throw new Error("Connection failed: " + err.message);
    }
  }

  // ====== PIN LOGIC ======
  function checkPin() {
    if ((document.getElementById("pinInput").value || "").trim() === ACCESS_PIN) {
      document.getElementById("pinGate").style.display = "none";
      sessionStorage.setItem("ep_pin_ok", "1");
    } else {
      document.getElementById("pinError").style.display = "block";
    }
  }

  window.addEventListener("load", () => {
    if (sessionStorage.getItem("ep_pin_ok") === "1") document.getElementById("pinGate").style.display = "none";
  });

  // ====== PHOTO HELPERS ======
  function resolvePhotoSrc(stu) {
    if (!stu) return "";
    const url = String(stu.PhotoURL || "").trim();
    const fileId = String(stu.PhotoFileId || "").trim();
    // Cache buster is vital to prevent browser showing old/broken versions
    if (url) return url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
    if (fileId) return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800&v=${Date.now()}`;
    return "";
  }

  function renderPhotoPanel(stu) {
    const photoPanel = document.getElementById("photoPanel");
    if (!stu || !stu.Email) { photoPanel.style.display = "none"; return; }
    photoPanel.style.display = "block";

    const storedSrc = resolvePhotoSrc(stu);
    const appPhotoImg = document.getElementById("appPhotoImg");
    
    if (storedSrc) {
      appPhotoImg.src = storedSrc;
    } else if (selectedPhotoDataUrl) {
      appPhotoImg.src = selectedPhotoDataUrl;
    } else {
      appPhotoImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="#eee"/><text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-family="sans-serif">No Photo</text></svg>');
    }

    document.getElementById("uploadPhotoBtn").disabled = !selectedPhotoDataUrl;
    document.getElementById("clearPhotoSelectionBtn").disabled = !selectedPhotoDataUrl;
  }

  // ====== PHOTO UPLOAD EVENT ======
  document.getElementById("photoInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 4 * 1024 * 1024) return alert("File too large (Max 4MB)");
    
    const reader = new FileReader();
    reader.onload = () => {
      selectedPhotoDataUrl = reader.result;
      renderPhotoPanel(currentStudent);
    };
    reader.readAsDataURL(file);
  });

  document.getElementById("uploadPhotoBtn").addEventListener("click", async () => {
    const off = (document.getElementById("officerName").value || "").trim();
    if (!off) return alert("Enter officer name.");
    
    const btn = document.getElementById("uploadPhotoBtn");
    btn.disabled = true;
    document.getElementById("photoHint").textContent = "Uploading to Drive...";

    try {
      const result = await api("uploadPhoto", {
        token: ACCESS_PIN,
        email: currentStudent.Email,
        studentId: currentStudent.StudentID,
        officer: off,
        dataUrl: selectedPhotoDataUrl
      });

      // Crucial: Update state with returned data to avoid stale fetch
      currentStudent = result.student;
      selectedPhotoDataUrl = "";
      document.getElementById("photoInput").value = "";
      
      setStudentUI(currentStudent);
      await refreshList();
      document.getElementById("photoHint").textContent = "Upload successful!";
    } catch (e) {
      alert(e.message);
      document.getElementById("photoHint").textContent = "Upload failed.";
    } finally {
      btn.disabled = false;
    }
  });

  document.getElementById("clearPhotoSelectionBtn").addEventListener("click", () => {
    selectedPhotoDataUrl = "";
    document.getElementById("photoInput").value = "";
    renderPhotoPanel(currentStudent);
  });

  // ====== CORE UI LOGIC ======
  function setStudentUI(stu) {
    currentStudent = stu;
    const stageEl = document.getElementById("currentStage");
    
    if (stu) {
      stageEl.textContent = stu.CurrentStage;
      stageEl.classList.remove("neutral");
      document.getElementById("currentStudentMeta").textContent = `ID: ${stu.StudentID} | ${stu.Email}`;
      
      // Update Big Preview
      const bigImg = document.getElementById("photoPreview");
      const src = resolvePhotoSrc(stu);
      if (src) {
        bigImg.src = src;
        bigImg.style.display = "block";
      } else {
        bigImg.style.display = "none";
      }
      document.getElementById("photoBadge").textContent = stu.CurrentStage;
    }

    document.getElementById("stageSelect").disabled = !stu;
    document.getElementById("updateStageBtn").disabled = !stu;
    document.getElementById("printCardBtn").disabled = !stu;
    
    renderPhotoPanel(stu);
    updateZohoUI();
  }

  async function refreshList() {
    const list = await api("listStudents", {});
    const tbody = document.querySelector("#studentsTable tbody");
    tbody.innerHTML = "";
    list.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${s.StudentID}</td><td>${s.FullName}</td><td><a href="#" class="load-stu" data-email="${s.Email}">${s.Email}</a></td><td>${s.Programme}</td><td><span class="pill">${s.CurrentStage}</span></td><td>${s.LastUpdatedAt.split('T')[0]}</td><td>${s.LastUpdatedBy}</td>`;
      tbody.appendChild(tr);
    });
  }

  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("load-stu")) {
      e.preventDefault();
      const stu = await api("getStudentByEmail", { email: e.target.dataset.email });
      setStudentUI(stu);
    }
  });

  document.getElementById("createLoadBtn").addEventListener("click", async () => {
    const payload = {
      officer: document.getElementById("officerName").value,
      fullName: document.getElementById("fullName").value,
      email: document.getElementById("email").value,
      programme: document.getElementById("programme").value,
      intake: document.getElementById("intake").value,
      nationality: document.getElementById("nationality").value,
    };
    const stu = await api("createOrLoadStudent", payload);
    setStudentUI(stu);
    await refreshList();
  });

  // Zoho UI visibility
  function updateZohoUI() {
    const block = document.getElementById("zohoBlock");
    const isEligible = currentStudent && (currentStudent.CurrentStage || "").includes("Eligible");
    block.style.display = isEligible ? "block" : "none";
    document.getElementById("openZohoPrefillBtn").disabled = !isEligible;
    document.getElementById("copyZohoPrefillBtn").disabled = !isEligible;
  }

  // Initial Load
  refreshList();

  const STAGES = ["Application Submitted", "Under Review", "Eligible – Conditional", "Conditional LoA Issued", "Accepted by Applicant", "Declarations Signed", "Fees Paid", "Final Enrolment Confirmed", "Enrolled / Arrived", "Completed", "Rejected", "Withdrawn"];
  const ss = document.getElementById("stageSelect");
  STAGES.forEach(st => { const o = document.createElement("option"); o.value = st; o.textContent = st; ss.appendChild(o); });

</script>
</body>
</html>
